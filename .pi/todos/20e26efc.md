{
  "id": "20e26efc",
  "title": "CI job: run setup + tests on fresh Ubuntu droplet per PR",
  "tags": [
    "infra",
    "ci",
    "ubuntu"
  ],
  "status": "done",
  "created_at": "2026-02-17T02:30:52.375Z"
}

## Result
Implemented and verified end-to-end. Workflow will activate once PR merges to main (GH Actions limitation: new workflow files in PRs don't trigger until they exist on the base branch).

### What was built
- **`bin/ci/droplet.sh`** — reusable DO droplet lifecycle: `create`, `destroy`, `wait-ssh`, `run`
- **`bin/ci/setup-ubuntu.sh`** — Ubuntu-specific: prereqs, setup.sh, test suite
- **`.github/workflows/integration.yml`** — matrix-based workflow (Ubuntu now, extensible)

### Design
- **Ephemeral everything**: fresh droplet + SSH key generated per run, destroyed on cleanup
- **Single secret**: `DO_API_TOKEN` (set in GitHub repo)
- **Matrix**: `include` array with `distro`, `image`, `setup_script` — add Arch/other by adding entries
- **Concurrency group**: one run at a time per PR
- **Always cleanup**: `if: always()` destroys droplet + SSH key even on failure

### Local test results (3 full cycles)
- Create droplet: ~15s
- SSH ready: ~10s
- Prereqs + setup + deploy: ~90s
- Tests (5 suites): ~10s
- Destroy: instant
- **Total: ~2 minutes per run**
- All 5 test suites pass on fresh Ubuntu 24.04

### PR
https://github.com/modem-dev/hornet/pull/10
