{
  "id": "20e26efc",
  "title": "CI job: run setup + tests on fresh Ubuntu droplet per PR",
  "tags": [
    "infra",
    "ci",
    "ubuntu"
  ],
  "status": "todo",
  "created_at": "2026-02-17T02:30:52.375Z",
  "assigned_to_session": "381813d9-c69a-4472-9a00-e232ffb746d1"
}

## Goal
Add a GitHub Actions workflow that spins up a fresh DigitalOcean droplet, runs the full hornet setup + test suite, and destroys it — on every PR.

## Verified approach
Tested manually — full destroy/create/setup/test cycle works end-to-end in ~2 minutes.

| Step | Method | Time |
|------|--------|------|
| Fresh env | Create droplet via DO API | ~45s |
| Wait for SSH | Poll until port 22 responds | ~15s |
| Prereqs | `apt-get install git curl tmux iptables docker.io` (wait for unattended-upgrades lock first) | ~20s |
| Source | `tar + scp + extract + git init` | ~5s |
| Setup | `setup.sh hornet_admin` | ~60s |
| Tests | `npm install + bin/test.sh` | ~15s |
| Cleanup | Destroy droplet + delete SSH key from DO (always, even on failure) | instant |

## GitHub Actions secrets needed
- `DO_API_TOKEN` — DigitalOcean API token

That's it. SSH keys are **ephemeral per run**:
1. `ssh-keygen` a throwaway ed25519 keypair on the runner
2. Register pubkey with DO API → get `ssh_key_id`
3. Create droplet with that `ssh_key_id`
4. Use the private key to SSH in
5. Cleanup: destroy droplet AND delete SSH key from DO account

No persistent SSH keys stored anywhere.

## Design
- **Ephemeral everything**: fresh droplet, fresh SSH key, destroyed after. Zero state between runs.
- **Concurrency group**: only one integration run at a time (avoid parallel droplets piling up).
- **Always cleanup**: use `if: always()` so droplet + SSH key are destroyed even if tests fail.
- **Region/size**: `tor1`, `s-2vcpu-4gb` (~$0.003/run at ~2 min).
- **Unattended-upgrades**: fresh Ubuntu runs apt on first boot — CI must wait for the dpkg lock.

## Steps
1. Add `DO_API_TOKEN` secret to GitHub repo via `gh secret set`
2. Write `.github/workflows/integration.yml`
3. Test on a real PR
4. Optionally add status badge to README

## Workflow skeleton
```yaml
name: Integration (Ubuntu)
on:
  pull_request:
    branches: [main]

concurrency:
  group: integration-ubuntu
  cancel-in-progress: true

jobs:
  integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate ephemeral SSH key
        run: |
          ssh-keygen -t ed25519 -f ~/.ssh/ci_key -N "" -q
          # Register with DO, save key ID
      - name: Create droplet
        # POST /v2/droplets with ssh_key_id, poll until active, extract IP
      - name: Wait for SSH
        # Loop ssh -o ConnectTimeout=5 until success
      - name: Install prereqs
        # Wait for apt lock, then apt-get install
      - name: Upload source
        # tar + scp
      - name: Run setup
        # setup.sh hornet_admin
      - name: Run tests
        # npm install + bin/test.sh
      - name: Cleanup
        if: always()
        run: |
          # DELETE /v2/droplets/$DROPLET_ID
          # DELETE /v2/account/keys/$SSH_KEY_ID
```
