#!/bin/bash
# Baudbot CLI dispatcher
# Routes subcommands to internal scripts. Installed as /usr/local/bin/baudbot.
#
# Usage: baudbot <command> [options]

set -euo pipefail

# Find the baudbot source root. Resolution order:
# 1. BAUDBOT_ROOT env var (explicit override)
# 2. Resolve from this script's real location (follow symlinks, then ../)
if [ -z "${BAUDBOT_ROOT:-}" ]; then
  SCRIPT="$0"
  # Follow symlinks to find the real script location
  while [ -L "$SCRIPT" ]; do
    DIR="$(cd "$(dirname "$SCRIPT")" && pwd)"
    SCRIPT="$(readlink "$SCRIPT")"
    # Handle relative symlinks
    [[ "$SCRIPT" != /* ]] && SCRIPT="$DIR/$SCRIPT"
  done
  BAUDBOT_ROOT="$(cd "$(dirname "$SCRIPT")/.." && pwd)"
fi

# Colors (disabled if not a terminal)
if [ -t 1 ]; then
  BOLD='\033[1m'
  RESET='\033[0m'
else
  BOLD='' RESET=''
fi

version() {
  if [ -f "$BAUDBOT_ROOT/package.json" ]; then
    grep '"version"' "$BAUDBOT_ROOT/package.json" | head -1 | sed 's/.*: *"\(.*\)".*/\1/'
  else
    echo "unknown"
  fi
}

usage() {
  echo -e "${BOLD}baudbot${RESET} — hardened infrastructure for always-on AI agents"
  echo ""
  echo -e "${BOLD}Usage:${RESET} baudbot <command> [options]"
  echo ""
  echo -e "${BOLD}Lifecycle:${RESET}"
  echo "  start          Start the agent (systemd, or --direct for foreground)"
  echo "  stop           Stop the agent"
  echo "  restart        Restart the agent"
  echo "  status         Show agent status"
  echo "  logs           Tail agent logs"
  echo "  attach         Attach to a tmux session (default: first available)"
  echo "  sessions       List agent tmux and pi sessions"
  echo ""
  echo -e "${BOLD}Setup:${RESET}"
  echo "  setup          One-time system setup (user, deps, firewall, systemd)"
  echo "  config         Interactive secrets and config setup"
  echo "  deploy         Deploy source + config to agent runtime"
  echo ""
  echo -e "${BOLD}Operations:${RESET}"
  echo "  doctor         Health check (perms, firewall, secrets, deps)"
  echo "  audit          Security posture audit"
  echo "  test           Run test suite"
  echo "  update         Build/test in temp checkout, publish git-free release, deploy"
  echo "  rollback       Re-deploy previous (or specified) git-free release snapshot"
  echo "  uninstall      Remove everything"
  echo ""
  echo -e "${BOLD}Options:${RESET}"
  echo "  --version      Show version"
  echo "  --help, -h     Show this help"
}

require_root() {
  if [ "$(id -u)" -ne 0 ]; then
    echo "❌ baudbot $1 requires root. Run: sudo baudbot $1"
    exit 1
  fi
}

# Detect systemd
has_systemd() {
  command -v systemctl &>/dev/null && [ -d /run/systemd/system ]
}

case "${1:-}" in
  start)
    shift
    if [ "${1:-}" = "--direct" ]; then
      # Foreground mode: run start.sh directly (for dev/CI/debugging)
      shift
      require_root "start --direct"
      exec sudo -u baudbot_agent "$BAUDBOT_ROOT/start.sh" "$@"
    else
      require_root "start"
      if has_systemd; then
        exec systemctl start baudbot "$@"
      else
        echo "systemd not available. Use: baudbot start --direct"
        exit 1
      fi
    fi
    ;;

  stop)
    shift
    require_root "stop"
    if has_systemd; then
      exec systemctl stop baudbot "$@"
    else
      echo "systemd not available. Kill the agent process manually."
      exit 1
    fi
    ;;

  restart)
    shift
    require_root "restart"
    if has_systemd; then
      exec systemctl restart baudbot "$@"
    else
      echo "systemd not available."
      exit 1
    fi
    ;;

  status)
    shift
    if has_systemd && systemctl is-enabled baudbot &>/dev/null; then
      exec systemctl status baudbot "$@"
    else
      # Fallback: check if baudbot_agent has pi running
      if pgrep -u baudbot_agent -f "pi --session-control" &>/dev/null; then
        echo "baudbot is running (no systemd unit)"
        pgrep -u baudbot_agent -af "pi --session-control"
      else
        echo "baudbot is not running"
      fi
    fi
    ;;

  logs)
    shift
    if has_systemd && systemctl is-enabled baudbot &>/dev/null; then
      exec journalctl -u baudbot -f "$@"
    else
      echo "No systemd unit. Check tmux sessions:"
      echo "  sudo -u baudbot_agent tmux ls"
    fi
    ;;

  sessions)
    shift
    require_root "sessions"
    AGENT_USER="baudbot_agent"
    echo -e "${BOLD}tmux sessions:${RESET}"
    if sudo -u "$AGENT_USER" tmux ls 2>/dev/null; then
      :
    else
      echo "  (none)"
    fi
    echo ""
    echo -e "${BOLD}pi sessions:${RESET}"
    # Pi stores live session control sockets in ~/.pi/session-control/<uuid>.sock
    # Named sessions have symlinks: <name>.sock → <uuid>.sock
    PI_CONTROL_DIR="/home/$AGENT_USER/.pi/session-control"
    if [ -d "$PI_CONTROL_DIR" ]; then
      found=0
      # Collect alias symlinks: name → uuid
      declare -A ALIASES
      for sock in "$PI_CONTROL_DIR"/*.sock; do
        [ -e "$sock" ] || continue
        base=$(basename "$sock" .sock)
        if [ -L "$sock" ]; then
          # Symlink = alias. Resolve target to get the uuid.
          target=$(readlink "$sock")
          target_uuid=$(basename "$target" .sock)
          ALIASES[$target_uuid]="$base"
        fi
      done
      # List actual sockets (non-symlinks)
      for sock in "$PI_CONTROL_DIR"/*.sock; do
        [ -e "$sock" ] || continue
        [ -L "$sock" ] && continue  # skip alias symlinks
        sess_id=$(basename "$sock" .sock)
        name="${ALIASES[$sess_id]:-}"
        # Liveness check: try connecting to the socket
        status="stopped (stale)"
        if sudo -u "$AGENT_USER" bash -c "echo '' | socat - UNIX-CONNECT:'$sock' 2>/dev/null" 2>/dev/null; then
          status="running"
        elif sudo -u "$AGENT_USER" bash -c "python3 -c \"import socket; s=socket.socket(socket.AF_UNIX); s.settimeout(0.3); s.connect('$sock'); s.close()\" 2>/dev/null" 2>/dev/null; then
          status="running"
        fi
        if [ -n "$name" ]; then
          echo "  $name ($sess_id) [$status]"
        else
          echo "  $sess_id [$status]"
        fi
        found=$((found + 1))
      done
      if [ "$found" -eq 0 ]; then
        echo "  (none)"
      fi
    else
      echo "  (no session-control directory)"
    fi
    ;;

  attach)
    shift
    require_root "attach"
    AGENT_USER="baudbot_agent"
    TARGET="${1:-}"
    if [ -z "$TARGET" ]; then
      # Default: attach to first available tmux session
      FIRST_SESSION=$(sudo -u "$AGENT_USER" tmux ls -F '#{session_name}' 2>/dev/null | head -1)
      if [ -n "$FIRST_SESSION" ]; then
        TARGET="$FIRST_SESSION"
      else
        echo "No tmux sessions running. Start the agent first:"
        echo "  sudo baudbot start"
        exit 1
      fi
    fi
    echo "Attaching to tmux session: $TARGET"
    echo "Detach with: Ctrl+b, d"
    echo ""
    exec sudo -u "$AGENT_USER" tmux attach-session -t "$TARGET"
    ;;

  setup)
    shift
    require_root "setup"
    exec "$BAUDBOT_ROOT/setup.sh" "$@"
    ;;

  config)
    shift
    exec "$BAUDBOT_ROOT/bin/config.sh" "$@"
    ;;

  deploy)
    shift
    require_root "deploy"
    exec "$BAUDBOT_ROOT/bin/deploy.sh" "$@"
    ;;

  audit)
    shift
    exec "$BAUDBOT_ROOT/bin/security-audit.sh" "$@"
    ;;

  test)
    shift
    exec "$BAUDBOT_ROOT/bin/test.sh" "$@"
    ;;

  update)
    shift
    require_root "update"
    exec "$BAUDBOT_ROOT/bin/update-release.sh" "$@"
    ;;

  rollback)
    shift
    require_root "rollback"
    exec "$BAUDBOT_ROOT/bin/rollback-release.sh" "$@"
    ;;

  uninstall)
    shift
    require_root "uninstall"
    exec "$BAUDBOT_ROOT/bin/uninstall.sh" "$@"
    ;;

  doctor)
    shift
    exec "$BAUDBOT_ROOT/bin/doctor.sh" "$@"
    ;;

  --version|-v)
    echo "baudbot $(version)"
    ;;

  --help|-h|"")
    usage
    ;;

  *)
    echo "Unknown command: $1"
    echo ""
    usage
    exit 1
    ;;
esac
